<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit File GitHub + Auto Repo/File</title>
  <style>
    body {font-family: Arial, sans-serif; background: #f8f8f8; margin: 0; color: #333;}
    h1 {text-align: center; margin-top: 30px; color: #2c3e50;}
    .container {width: 90%; max-width: 900px; margin: 20px auto; background: #fff; padding: 20px;
      border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);}
    select, textarea, input {
      width: 100%; margin-top: 10px; padding: 10px;
      font-size: 1rem; border: 1px solid #ddd; border-radius: 5px; background: #fafafa;
    }
    textarea {min-height: 200px; resize: vertical;}
    button {margin-top: 15px; padding: 10px 20px; background: #4CAF50; color: white; border: none;
      border-radius: 5px; cursor: pointer;}
    button:hover {background: #45a049;}
    .footer {text-align:center; margin-top:30px; font-size:.9rem; color:#7f8c8d;}
    .row {display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .row > * {flex:1; min-width:120px;}
    #tokenStatus {margin-top:5px; font-size:0.9rem; color:green;}

    /* üîπ HIDDEN BRANCH FIELD */
    #branch {
      display: none;
    }
  </style>
</head>
<body>
  <h1>Menampilkan dan Mengedit File GitHub</h1>
  <div class="container">
    <div>
      <input type="password" id="token" placeholder="Masukkan token GitHub kamu">
      <div id="tokenStatus"></div>
      <button onclick="saveToken()">üíæ Simpan Token</button>
      <button onclick="clearToken()" style="background:#c0392b;">‚ùå Hapus Token</button>
    </div>

    <div class="file-select">
      <div class="row">
        <input type="text" id="owner" placeholder="Username" readonly>
        <select id="repoSelect"></select>

        <!-- üîπ HIDDEN BRANCH FIELD (nilai tetap 'main') -->
        <input type="text" id="branch" value="main" placeholder="Branch">
      </div>

      <select id="fileList" onchange="onSelectFile()">
        <option value="">-- memilih file otomatis --</option>
      </select>
      <button id="backButton" onclick="goBack()" style="display:none;margin-top:10px;background:#888;">üîô Kembali</button>
    </div>

    <div>
      <textarea id="fileContent" placeholder="Konten file akan muncul di sini..."></textarea>
      <button onclick="updateFile()">üíæ Simpan ke GitHub</button>
    </div>
  </div>

  <div class="footer">
    <p>Powered by <strong>GitHub API</strong> ‚Ä¢ Auto Username + Repo + File</p>
  </div>

  <script>
    let currentPath = "";

    const getToken = () => localStorage.getItem("github_token") || document.getElementById("token").value;

    async function getUsernameFromToken() {
      const token = getToken();
      if (!token) return;
      try {
        const res = await fetch("https://api.github.com/user", {
          headers: { Authorization: `token ${token}` }
        });
        const data = await res.json();
        if (data.login) {
          document.getElementById("owner").value = data.login;
          localStorage.setItem("github_user", data.login);
        } else alert("‚ùå Token tidak valid.");
      } catch {
        alert("‚ùå Gagal mengakses API GitHub.");
      }
    }

    function saveToken() {
      const token = document.getElementById("token").value;
      if (!token) return;
      localStorage.setItem("github_token", token);
      showTokenStatus(true);
      initLoad(); // langsung mulai proses
    }

    function clearToken() {
      localStorage.clear();
      document.getElementById("token").value = "";
      document.getElementById("owner").value = "";
      document.getElementById("repoSelect").innerHTML = "";
      document.getElementById("fileList").innerHTML = "";
      showTokenStatus(false);
    }

    function showTokenStatus(saved) {
      const el = document.getElementById("tokenStatus");
      el.textContent = saved ? "‚úÖ Token tersimpan di browser" : "‚ùå Token belum tersimpan";
    }

    async function loadRepos() {
      const token = getToken();
      const res = await fetch(`https://api.github.com/user/repos?per_page=100`, {
        headers: { Authorization: `token ${token}` }
      });
      const data = await res.json();
      const select = document.getElementById("repoSelect");
      select.innerHTML = "";
      if (!Array.isArray(data)) return alert("‚ùå Tidak dapat memuat repositori.");

      data.forEach(repo => {
        const opt = document.createElement("option");
        opt.value = repo.name;
        opt.textContent = repo.name;
        select.appendChild(opt);
      });

      const lastRepo = localStorage.getItem("last_repo");
      const owner = localStorage.getItem("github_user");
      const currentOwner = document.getElementById("owner").value;

      if (lastRepo && owner === currentOwner && data.some(r => r.name === lastRepo)) {
        select.value = lastRepo;
      } else {
        select.selectedIndex = 0; // pakai repo pertama kalau belum pernah
      }

      localStorage.setItem("last_repo", select.value);
      await loadFileList();
    }

    async function loadFileList(path = "") {
      const owner = document.getElementById("owner").value;
      const repo = document.getElementById("repoSelect").value;
      const branch = document.getElementById("branch").value;
      const token = getToken();

      const url = path
        ? `https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`
        : `https://api.github.com/repos/${owner}/${repo}/contents?ref=${branch}`;

      const res = await fetch(url, { headers: { Authorization: `token ${token}` } });
      const data = await res.json();
      const fileList = document.getElementById("fileList");
      fileList.innerHTML = "";

      if (Array.isArray(data)) {
        data.forEach(item => {
          const opt = document.createElement("option");
          opt.value = item.path;
          opt.textContent = item.type === "dir" ? "üìÅ " + item.name : "üìÑ " + item.name;
          fileList.appendChild(opt);
        });
        currentPath = path;
        document.getElementById("backButton").style.display = path ? "inline-block" : "none";

        // langsung buka file pertama yang bukan folder
        const firstFile = data.find(i => i.type === "file");
        if (firstFile) loadFile(firstFile.path);
      } else {
        alert("‚ùå Gagal memuat file list.");
      }
    }

    function goBack() {
      if (!currentPath) return;
      const parts = currentPath.split("/");
      parts.pop();
      loadFileList(parts.join("/"));
    }

    function onSelectFile() {
      const selected = document.getElementById("fileList").selectedOptions[0];
      if (!selected) return;
      const value = selected.value;
      if (selected.textContent.startsWith("üìÅ")) loadFileList(value);
      else loadFile(value);
    }

    async function loadFile(filePath) {
      const owner = document.getElementById("owner").value;
      const repo = document.getElementById("repoSelect").value;
      const branch = document.getElementById("branch").value;
      const token = getToken();

      const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${filePath}?ref=${branch}`, {
        headers: { Authorization: `token ${token}` }
      });
      const data = await res.json();
      if (data.content) {
        document.getElementById("fileContent").value = atob(data.content);
        localStorage.setItem("last_sha", data.sha);
        localStorage.setItem("last_path", filePath);
      }
    }

    async function updateFile() {
      const owner = document.getElementById("owner").value;
      const repo = document.getElementById("repoSelect").value;
      const branch = document.getElementById("branch").value;
      const filePath = localStorage.getItem("last_path");
      const token = getToken();
      const content = btoa(document.getElementById("fileContent").value);
      const sha = localStorage.getItem("last_sha");

      const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${filePath}`, {
        method: "PUT",
        headers: {
          "Authorization": `token ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          message: `Update ${filePath} via web editor`,
          content, sha, branch
        })
      });
      const data = await res.json();
      alert(data.commit ? "‚úÖ File berhasil diperbarui di GitHub!" : "‚ùå Gagal update file.");
    }

    async function initLoad() {
      const token = localStorage.getItem("github_token");
      if (!token) return showTokenStatus(false);
      document.getElementById("token").value = token;
      showTokenStatus(true);
      await getUsernameFromToken();
      await loadRepos();
    }

    window.onload = initLoad;
  </script>
</body>
</html>