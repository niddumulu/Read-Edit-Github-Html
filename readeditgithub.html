<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Edit File GitHub (Auto Repo + File)</title>
<style>
  body { font-family: Arial, sans-serif; background: #f9f9f9; margin: 0; color: #333; }
  .container { max-width: 900px; margin: 20px auto; background: #fff; padding: 20px;
    border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
  h1 { text-align: center; color: #2c3e50; }
  select, input, textarea, button {
    width: 100%; padding: 10px; margin-top: 8px;
    border: 1px solid #ccc; border-radius: 5px; font-size: 1rem;
  }
  textarea { font-family: monospace; min-height: 300px; resize: vertical; }
  button { background: #4CAF50; color: #fff; border: none; cursor: pointer; }
  button:hover { background: #45a049; }
  .danger { background: #c0392b; }
  #branch { display: none; }
  #loading { display: none; text-align: center; margin-top: 10px; color: #888; }
</style>
</head>
<body>
<div class="container">
  <h1>Editor File GitHub</h1>

  <input type="password" id="token" placeholder="Masukkan GitHub Token">
  <div id="tokenStatus"></div>
  <button onclick="saveToken()">üíæ Simpan Token</button>
  <button onclick="clearToken()" class="danger">‚ùå Hapus Token</button>

  <input type="text" id="owner" placeholder="Username" readonly>
  <select id="repoSelect"><option>Menunggu...</option></select>
  <input type="text" id="branch" value="main">
  <div id="loading">‚è≥ Memuat data...</div>

  <select id="fileList" onchange="onSelectFile()"><option>Menunggu...</option></select>
  <button id="backButton" onclick="goBack()" style="display:none;background:#777;">‚¨ÖÔ∏è Kembali</button>

    <div>
      <!-- üîπ Tambahkan toolbar kecil di atas editor -->
      <div style="display:flex; gap:8px; margin-top:15px; align-items:center;">
        <strong>üìù Editor File</strong>
        <button onclick="clearEditor()" style="background:#e74c3c;">üßπ Hapus</button>
        <button onclick="pasteFromClipboard()" style="background:#3498db;">üìã Paste</button>
      </div>

  <textarea id="fileContent" placeholder="Isi file..."></textarea>
  <button onclick="updateFile()">üöÄ Simpan ke GitHub</button>
</div>

<script>
let currentPath = "";

function getToken() {
  return localStorage.getItem("github_token") || document.getElementById("token").value;
}

function showTokenStatus(saved) {
  const el = document.getElementById("tokenStatus");
  el.textContent = saved ? "‚úÖ Token tersimpan" : "‚ùå Token belum tersimpan";
  el.style.color = saved ? "green" : "red";
}

async function getUsernameFromToken() {
  const token = getToken();
  if (!token) return null;
  const res = await fetch("https://api.github.com/user", {
    headers: { Authorization: `token ${token}` }
  });
  const data = await res.json();
  if (data.login) {
    document.getElementById("owner").value = data.login;
    localStorage.setItem("github_user", data.login);
    return data.login;
  } else {
    alert("Token tidak valid");
    return null;
  }
}

async function loadRepos() {
  const token = getToken();
  const res = await fetch("https://api.github.com/user/repos?per_page=100", {
    headers: { Authorization: `token ${token}` }
  });
  const data = await res.json();
  const select = document.getElementById("repoSelect");
  select.innerHTML = "";

  if (!Array.isArray(data)) {
    select.innerHTML = "<option>Gagal memuat repositori</option>";
    return;
  }

  data.forEach(repo => {
    const opt = document.createElement("option");
    opt.value = repo.name;
    opt.textContent = repo.name;
    select.appendChild(opt);
  });

  const lastRepo = localStorage.getItem("last_repo");
  if (lastRepo && data.some(r => r.name === lastRepo)) {
    select.value = lastRepo;
  }

  // Event change REPO ‚Üí muat ulang file list
  select.onchange = async () => {
    localStorage.setItem("last_repo", select.value);
    currentPath = "";
    await loadFileList();
  };

  await loadFileList();
}

async function loadFileList(path = "") {
  const owner = document.getElementById("owner").value;
  const repo = document.getElementById("repoSelect").value;
  const branch = document.getElementById("branch").value;
  const token = getToken();
  const fileList = document.getElementById("fileList");
  const loading = document.getElementById("loading");

  if (!owner || !repo || !token) return;

  loading.style.display = "block";
  fileList.innerHTML = "<option>‚è≥ Memuat...</option>";

  const url = path
    ? `https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`
    : `https://api.github.com/repos/${owner}/${repo}/contents?ref=${branch}`;

  try {
    const res = await fetch(url, { headers: { Authorization: `token ${token}` } });
    const data = await res.json();

    fileList.innerHTML = "";
    if (!Array.isArray(data)) throw new Error("Bukan array");

    data.forEach(item => {
      const opt = document.createElement("option");
      opt.value = item.path;
      opt.textContent = item.type === "dir" ? "üìÅ " + item.name : "üìÑ " + item.name;
      fileList.appendChild(opt);
    });

    currentPath = path;
    document.getElementById("backButton").style.display = path ? "inline-block" : "none";

    // Auto buka file pertama
    const firstFile = data.find(i => i.type === "file");
    if (firstFile) await loadFile(firstFile.path);

  } catch (err) {
    fileList.innerHTML = "<option>‚ùå Gagal memuat file</option>";
  }

  loading.style.display = "none";
}

function goBack() {
  if (!currentPath) return;
  const parts = currentPath.split("/");
  parts.pop();
  loadFileList(parts.join("/"));
}

function onSelectFile() {
  const selected = document.getElementById("fileList").selectedOptions[0];
  if (!selected) return;
  const value = selected.value;
  if (selected.textContent.startsWith("üìÅ")) loadFileList(value);
  else loadFile(value);
}

async function loadFile(filePath) {
  const owner = document.getElementById("owner").value;
  const repo = document.getElementById("repoSelect").value;
  const branch = document.getElementById("branch").value;
  const token = getToken();

  const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${filePath}?ref=${branch}`, {
    headers: { Authorization: `token ${token}` }
  });
  const data = await res.json();
  if (data.content) {
    document.getElementById("fileContent").value = atob(data.content);
    localStorage.setItem("last_path", filePath);
    localStorage.setItem("last_sha", data.sha);
  }
}

async function updateFile() {
  const owner = document.getElementById("owner").value;
  const repo = document.getElementById("repoSelect").value;
  const branch = document.getElementById("branch").value;
  const token = getToken();
  const filePath = localStorage.getItem("last_path");
  const sha = localStorage.getItem("last_sha");
  const content = btoa(document.getElementById("fileContent").value);

  const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${filePath}`, {
    method: "PUT",
    headers: {
      Authorization: `token ${token}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      message: `Update ${filePath} via Web Editor`,
      content, sha, branch
    })
  });
  const data = await res.json();
  alert(data.commit ? "‚úÖ File berhasil diperbarui!" : "‚ùå Gagal menyimpan file!");
}

function saveToken() {
  const token = document.getElementById("token").value;
  if (!token) return alert("Masukkan token!");
  localStorage.setItem("github_token", token);
  showTokenStatus(true);
  initLoad();
}

function clearToken() {
  localStorage.clear();
  document.getElementById("token").value = "";
  document.getElementById("owner").value = "";
  showTokenStatus(false);
}

async function initLoad() {
  const token = localStorage.getItem("github_token");
  if (!token) return showTokenStatus(false);
  document.getElementById("token").value = token;
  showTokenStatus(true);
  const user = await getUsernameFromToken();
  if (user) await loadRepos();
}

// üîπ Fungsi untuk menghapus isi editor
function clearEditor() {
  if (confirm("Hapus semua isi editor?")) {
    document.getElementById("fileContent").value = "";
  }
}

// üîπ Fungsi untuk paste teks dari clipboard
async function pasteFromClipboard() {
  try {
    const text = await navigator.clipboard.readText();
    const textarea = document.getElementById("fileContent");
    textarea.value += text;
    alert("‚úÖ Teks berhasil di-paste dari clipboard!");
  } catch (err) {
    alert("‚ùå Gagal membaca clipboard. Pastikan browser mengizinkan akses clipboard.");
  }
}

window.onload = initLoad;
</script>
</body>
</html>